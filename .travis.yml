
dist: trusty # Using Ububtu test environment.
sudo: false # Container based tests using Docker images.

language: ruby
rvm:
 - 2.4.1

env:
  - DB=mysql

script:
  - zip -r latest *
  - mkdir -p dpl_cd_upload
  - mv latest.zip dpl_cd_upload/latest.zip
  - RAILS_ENV=test bundle exec rake db:migrate --trace
  - bundle exec rake db:test:prepare
  - bundle exec rspec spec/
  
before_script:
  - mysql -e 'CREATE DATABASE IF NOT EXISTS test;'
  - mysql -e 'CREATE DATABASE uofmeme_app_test;'

bundler_args: --binstubs=./bundler_stubs

deploy:
- provider: s3
  access_key_id: $AWS_ACCESS_KEY
  secret_access_key: $AWS_SECRET_KEY
  local_dir: dpl_cd_upload
  skip_cleanup: true
  on: &2
    repo: git@github.com:talk2bryan/UofMeme.git
  bucket: uofmeme-s3-bucket
  region: us-east-2
- provider: codedeploy
  access_key_id: $AWS_ACCESS_KEY
  secret_access_key: $AWS_SECRET_KEY
  bucket: uofmeme-s3-bucket
  key: latest.zip
  bundle_type: zip
  application: UofMeme
  deployment_group: UofMeme
  region: us-east-2
  on: *2

after_deploy:
  - echo "done deploying"


